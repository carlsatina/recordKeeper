generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String            @id @default(cuid())
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  role              Role              @default(USER)
  fullName          String
  phone             String            @unique
  email             String?           @unique
  password          String?
  dateOfBirth       DateTime?
  imageUrl          String?
  budgets           Budget[]
  expenses          Expense[]
  expenseCategories ExpenseCategory[]
  financialGoals    FinancialGoal[]
  notifications     Notification[]
  otps              OtpCode[]
  profiles          Profile[]
  vehicles          Vehicle[]
}

model OtpCode {
  id        String   @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
}

model Profile {
  id                String             @id @default(cuid())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userId            String
  displayName       String
  relationToUser    String?
  dateOfBirth       DateTime?
  gender            String?
  bloodGroup        String?
  allergies         String?
  chronicConditions String?
  imageUrl          String?
  records           MedicalRecord[]
  medications       Medication[]
  medicineReminders MedicineReminder[]
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  vitals            VitalEntry[]
}

model MedicalRecord {
  id           String      @id @default(cuid())
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  profileId    String
  title        String
  recordType   RecordType  @default(OTHER)
  recordDate   DateTime
  providerName String?
  notes        String?
  tags         String[]    @default([])
  files        FileAsset[]
  profile      Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  shares       ShareLink[]

  @@index([profileId, recordDate])
  @@index([recordType])
}

model FileAsset {
  id           String         @id @default(cuid())
  createdAt    DateTime       @default(now())
  recordId     String?
  url          String
  mimeType     String?
  sizeBytes    Int?
  originalName String?
  record       MedicalRecord? @relation(fields: [recordId], references: [id], onDelete: Cascade)
}

model ShareLink {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  expiresAt   DateTime?
  recordId    String
  token       String        @unique
  canDownload Boolean       @default(true)
  targetEmail String?
  targetPhone String?
  record      MedicalRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
}

model Medication {
  id                String             @id @default(cuid())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  profileId         String
  name              String
  dosage            String?
  instructions      String?
  startDate         DateTime?
  endDate           DateTime?
  inventoryQuantity Int?
  lowStockThreshold Int?
  reminders         MedReminder[]
  profile           Profile            @relation(fields: [profileId], references: [id], onDelete: Cascade)
  logs              MedicationLog[]
  medicineReminders MedicineReminder[]

  @@index([profileId])
}

model MedReminder {
  id           String            @id @default(cuid())
  createdAt    DateTime          @default(now())
  medicationId String
  frequency    ReminderFrequency @default(DAILY)
  scheduleJson Json?
  nextRunAt    DateTime?
  active       Boolean           @default(true)
  medication   Medication        @relation(fields: [medicationId], references: [id], onDelete: Cascade)
}

model MedicationLog {
  id           String     @id @default(cuid())
  medicationId String
  occurredAt   DateTime
  status       String
  notes        String?
  medication   Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  @@index([medicationId, occurredAt])
}

model VitalEntry {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  profileId   String
  vitalType   VitalType @default(OTHER)
  valueNumber Float?
  unit        String?
  systolic    Int?
  diastolic   Int?
  recordedAt  DateTime  @default(now())
  notes       String?
  chartGroup  String?
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, recordedAt])
  @@index([vitalType])
}

model MedicineReminder {
  id           String      @id @default(cuid())
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  profileId    String
  medicineName String
  unit         String?
  dosage       Int?        @default(1)
  frequency    String
  time         String?
  times        String[]    @default([])
  duration     String?
  intakeMethod String?
  notes        String?
  medicationId String?
  active       Boolean     @default(true)
  medication   Medication? @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  profile      Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
}

model Notification {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  userId    String
  title     String
  body      String?
  readAt    DateTime?
  channel   String?
  data      Json?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Vehicle {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  userId             String
  vehicleType        VehicleType         @default(CAR)
  make               String
  model              String
  year               Int?
  color              String?
  licensePlate       String?
  vin                String?             @unique
  purchaseDate       DateTime?
  currentMileage     Int?
  imageUrl           String?
  notes              String?
  maintenanceRecords MaintenanceRecord[]
  maintenanceHistory CarMaintenanceHistory[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminders          VehicleReminder[]

  @@index([userId])
}

model MaintenanceRecord {
  id                 String          @id @default(cuid())
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  vehicleId          String
  maintenanceType    MaintenanceType @default(OTHER)
  title              String
  description        String?
  serviceDate        DateTime
  mileageAtService   Int?
  servicedBy         String?
  location           String?
  cost               Float?
  currency           String?         @default("USD")
  partsUsed          String?
  laborHours         Float?
  receiptUrl         String?
  tags               String[]        @default([])
  nextServiceDue     DateTime?
  nextServiceMileage Int?
  vehicle            Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, serviceDate])
  @@index([maintenanceType])
}

// Detailed maintenance history entries to track actual work performed
model CarMaintenanceHistory {
  id               String          @id @default(cuid())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  vehicleId        String
  maintenanceType  MaintenanceType @default(OTHER)
  title            String
  description      String?
  serviceDate      DateTime
  mileageAtService Int?
  serviceProvider  String?
  location         String?
  cost             Float?
  currency         String?         @default("USD")
  notes            String?
  attachments      CarMaintenanceAttachment[]
  parts            CarMaintenancePart[]
  vehicle          Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, serviceDate])
  @@index([maintenanceType])
}

model CarMaintenancePart {
  id            String                 @id @default(cuid())
  name          String
  quantity      Float?                 @default(1)
  unit          String?
  cost          Float?
  currency      String?                @default("USD")
  historyId     String
  history       CarMaintenanceHistory  @relation(fields: [historyId], references: [id], onDelete: Cascade)

  @@index([historyId])
}

model CarMaintenanceAttachment {
  id         String                 @id @default(cuid())
  createdAt  DateTime               @default(now())
  url        String
  mimeType   String?
  sizeBytes  Int?
  label      String?
  historyId  String
  history    CarMaintenanceHistory  @relation(fields: [historyId], references: [id], onDelete: Cascade)

  @@index([historyId])
}

model VehicleReminder {
  id              String          @id @default(cuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  vehicleId       String
  title           String
  description     String?
  maintenanceType MaintenanceType @default(OTHER)
  dueDate         DateTime?
  dueMileage      Int?
  notifyInAdvance Int?
  active          Boolean         @default(true)
  completed       Boolean         @default(false)
  completedAt     DateTime?
  vehicle         Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, dueDate])
  @@index([active, completed])
}

model ExpenseCategory {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  name      String
  color     String?
  icon      String?
  isDefault Boolean   @default(false)
  budgets   Budget[]
  expenses  Expense[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Expense {
  id             String           @id @default(cuid())
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  userId         String
  title          String
  description    String?
  amount         Float
  currency       String           @default("USD")
  expenseDate    DateTime         @default(now())
  categoryId     String?
  subcategory    String?
  tags           String[]         @default([])
  paymentMethod  PaymentMethod    @default(CASH)
  paymentAccount String?
  vendor         String?
  location       String?
  receiptUrl     String?
  notes          String?
  isRecurring    Boolean          @default(false)
  frequency      ExpenseFrequency @default(ONE_TIME)
  recurringUntil DateTime?
  category       ExpenseCategory? @relation(fields: [categoryId], references: [id])
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expenseDate])
  @@index([categoryId])
  @@index([isRecurring])
}

model Budget {
  id             String           @id @default(cuid())
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  userId         String
  name           String
  amount         Float
  currency       String           @default("USD")
  startDate      DateTime
  endDate        DateTime
  categoryId     String?
  alertThreshold Float?
  alertEnabled   Boolean          @default(true)
  active         Boolean          @default(true)
  category       ExpenseCategory? @relation(fields: [categoryId], references: [id])
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startDate, endDate])
  @@index([categoryId])
  @@index([active])
}

model FinancialGoal {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  userId        String
  title         String
  description   String?
  targetAmount  Float
  currentAmount Float     @default(0)
  currency      String    @default("USD")
  targetDate    DateTime?
  completed     Boolean   @default(false)
  completedAt   DateTime?
  color         String?
  icon          String?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([completed])
}

enum Role {
  USER
  ADMIN
}

enum RecordType {
  PRESCRIPTION
  DIAGNOSIS
  LAB_RESULT
  IMAGING
  VACCINATION
  DISCHARGE_SUMMARY
  OTHER
}

enum VitalType {
  HEART_RATE
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC
  BLOOD_GLUCOSE
  SPO2
  TEMPERATURE
  WEIGHT
  HEIGHT
  BMI
  RESPIRATORY_RATE
  OTHER
}

enum ReminderFrequency {
  ONCE
  HOURLY
  DAILY
  WEEKLY
  CUSTOM
}

enum VehicleType {
  CAR
  SUV
  PICKUP
  MOTORCYCLE
  TRUCK
  VAN
  OTHER
}

enum MaintenanceType {
  OIL_CHANGE
  BRAKE_PAD_REPLACEMENT
  TIRE_ROTATION
  TIRE_REPLACEMENT
  BATTERY_REPLACEMENT
  AIR_FILTER_REPLACEMENT
  TRANSMISSION_SERVICE
  COOLANT_FLUSH
  SPARK_PLUG_REPLACEMENT
  BRAKE_FLUID_CHANGE
  ALIGNMENT
  INSPECTION
  REPAIR
  OTHER
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  MOBILE_PAYMENT
  CHECK
  OTHER
}

enum ExpenseFrequency {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}
